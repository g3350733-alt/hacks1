--// Optimized Collapsible Utility GUI + Give All Items
--// LocalScript | StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- RemoteEvent
local giveAllEvent = ReplicatedStorage:WaitForChild("GiveAllItems")

-- STATES
local highlightsEnabled = false
local povLockEnabled = false
local infJumpEnabled = false
local noclipEnabled = false
local walkSpeed = 16

local highlights = {} -- {char=Highlight}
local characterCache = {} -- {player=char}
local closestTarget
local povTimer = 0
local povConnection
local noclipConnection

-- GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "OptimizedUtilityGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer.PlayerGui

-- Master Toggle
local MasterButton = Instance.new("TextButton")
MasterButton.Size = UDim2.new(0,220,0,50)
MasterButton.Position = UDim2.new(0,20,0.5,-150)
MasterButton.Text = "Toggle Utility GUI"
MasterButton.Font = Enum.Font.GothamBold
MasterButton.TextScaled = true
MasterButton.BackgroundColor3 = Color3.fromRGB(0,170,255)
MasterButton.TextColor3 = Color3.fromRGB(255,255,255)
MasterButton.Active = true
MasterButton.Parent = ScreenGui
MasterButton.Draggable = true

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0,220,0,50)
Frame.Position = UDim2.new(0,20,0.5,-100)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Visible = false
Frame.Parent = ScreenGui
Frame.Draggable = true

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0,5)
UIListLayout.FillDirection = Enum.FillDirection.Vertical
UIListLayout.Parent = Frame

MasterButton.MouseButton1Click:Connect(function()
	Frame.Visible = not Frame.Visible
end)

-- Collapsible Section Helper
local function createSection(title)
	local header = Instance.new("TextButton")
	header.Size = UDim2.new(0,200,0,40)
	header.BackgroundColor3 = Color3.fromRGB(50,50,50)
	header.TextColor3 = Color3.fromRGB(255,255,255)
	header.Font = Enum.Font.GothamBold
	header.TextScaled = true
	header.Text = title
	header.Active = true
	header.Parent = Frame

	local content = Instance.new("Frame")
	content.Size = UDim2.new(0,200,0,0)
	content.BackgroundTransparency = 1
	content.ClipsDescendants = true
	content.Parent = Frame

	local isOpen = false
	header.MouseButton1Click:Connect(function()
		isOpen = not isOpen
		content.Size = isOpen and UDim2.new(0,200,0,50) or UDim2.new(0,200,0,0)
		if isOpen and content:GetChildren()[1] == nil then
			-- Lazy create content buttons
			if title == "Highlight" then
				createToggleButton(content,"Highlight",
					function() return highlightsEnabled end,
					function()
						highlightsEnabled = not highlightsEnabled
						for _, hl in pairs(highlights) do
							hl.Enabled = highlightsEnabled
						end
					end
				)
			elseif title == "POV Lock" then
				createToggleButton(content,"POV Lock",
					function() return povLockEnabled end,
					function()
						povLockEnabled = not povLockEnabled
					end
				)
			elseif title == "Infinite Jump" then
				createToggleButton(content,"Infinite Jump",
					function() return infJumpEnabled end,
					function() infJumpEnabled = not infJumpEnabled end
				)
			elseif title == "NoClip" then
				createToggleButton(content,"NoClip",
					function() return noclipEnabled end,
					function() noclipEnabled = not noclipEnabled end
				)
			elseif title == "WalkSpeed" then
				createSpeedControls(content)
			elseif title == "Items" then
				createGiveAllButton(content)
			end
		end
	end)
	return content
end

-- Toggle Button Helper
function createToggleButton(parent,labelText,getStateFunc,callback)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,200,0,40)
	btn.BackgroundColor3 = getStateFunc() and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.Font = Enum.Font.GothamBold
	btn.TextScaled = true
	btn.Text = labelText.." : "..(getStateFunc() and "ON" or "OFF")
	btn.Active = true
	btn.Parent = parent

	btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(60,60,60) end)
	btn.MouseLeave:Connect(function() btn.BackgroundColor3 = getStateFunc() and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40) end)

	btn.MouseButton1Click:Connect(function()
		callback()
		btn.Text = labelText.." : "..(getStateFunc() and "ON" or "OFF")
		btn.BackgroundColor3 = getStateFunc() and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
	end)
	return btn
end

-- WalkSpeed Controls
function createSpeedControls(parent)
	local SpeedDown = Instance.new("TextButton")
	SpeedDown.Size = UDim2.new(0,50,0,40)
	SpeedDown.Position = UDim2.new(0,0,0,0)
	SpeedDown.Text = "-"
	SpeedDown.Font = Enum.Font.GothamBold
	SpeedDown.TextScaled = true
	SpeedDown.BackgroundColor3 = Color3.fromRGB(40,40,40)
	SpeedDown.TextColor3 = Color3.fromRGB(255,255,255)
	SpeedDown.Parent = parent

	local SpeedLabel = Instance.new("TextLabel")
	SpeedLabel.Size = UDim2.new(0,100,0,40)
	SpeedLabel.Position = UDim2.new(0,55,0,0)
	SpeedLabel.Text = walkSpeed
	SpeedLabel.Font = Enum.Font.GothamBold
	SpeedLabel.TextScaled = true
	SpeedLabel.BackgroundColor3 = Color3.fromRGB(40,40,40)
	SpeedLabel.TextColor3 = Color3.fromRGB(255,255,255)
	SpeedLabel.Parent = parent

	local SpeedUp = Instance.new("TextButton")
	SpeedUp.Size = UDim2.new(0,50,0,40)
	SpeedUp.Position = UDim2.new(0,160,0,0)
	SpeedUp.Text = "+"
	SpeedUp.Font = Enum.Font.GothamBold
	SpeedUp.TextScaled = true
	SpeedUp.BackgroundColor3 = Color3.fromRGB(40,40,40)
	SpeedUp.TextColor3 = Color3.fromRGB(255,255,255)
	SpeedUp.Parent = parent

	local function applySpeed()
		local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum.WalkSpeed = walkSpeed end
		SpeedLabel.Text = walkSpeed
	end
	SpeedUp.MouseButton1Click:Connect(function() walkSpeed = math.clamp(walkSpeed+4,8,200); applySpeed() end)
	SpeedDown.MouseButton1Click:Connect(function() walkSpeed = math.clamp(walkSpeed-4,8,200); applySpeed() end)
	LocalPlayer.CharacterAdded:Connect(function() task.wait(0.2); applySpeed() end)
end

-- Give All Items Button
function createGiveAllButton(parent)
	local GiveAllButton = Instance.new("TextButton")
	GiveAllButton.Size = UDim2.new(0,200,0,40)
	GiveAllButton.Text = "Give All Items"
	GiveAllButton.Font = Enum.Font.GothamBold
	GiveAllButton.TextScaled = true
	GiveAllButton.BackgroundColor3 = Color3.fromRGB(170,120,0)
	GiveAllButton.TextColor3 = Color3.fromRGB(255,255,255)
	GiveAllButton.Parent = parent

	GiveAllButton.MouseButton1Click:Connect(function()
		giveAllEvent:FireServer()
	end)
end

-- Create sections (buttons are lazy-loaded)
local highlightSection = createSection("Highlight")
local povSection = createSection("POV Lock")
local jumpSection = createSection("Infinite Jump")
local noclipSection = createSection("NoClip")
local speedSection = createSection("WalkSpeed")
local itemsSection = createSection("Items")

-- -----------------
-- Character Cache
-- -----------------
local function setupCharacter(plr)
	if plr == LocalPlayer then return end
	local function onChar(char)
		characterCache[plr] = char
		if highlightsEnabled and not highlights[char] then
			local hl = Instance.new("Highlight")
			hl.Adornee = char
			hl.FillColor = Color3.fromRGB(255,0,0)
			hl.OutlineColor = Color3.fromRGB(255,255,255)
			hl.FillTransparency = 0.5
			hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			hl.Enabled = highlightsEnabled
			hl.Parent = char
			highlights[char] = hl
		end
	end
	if plr.Character then onChar(plr.Character) end
	plr.CharacterAdded:Connect(onChar)
end
for _,plr in ipairs(Players:GetPlayers()) do setupCharacter(plr) end
Players.PlayerAdded:Connect(setupCharacter)
Players.PlayerRemoving:Connect(function(plr)
	local char = characterCache[plr]
	if char and highlights[char] then highlights[char]:Destroy() end
	characterCache[plr] = nil
end)

-- -----------------
-- POV Lock Update
-- -----------------
RunService.RenderStepped:Connect(function(dt)
	if povLockEnabled then
		povTimer += dt
		if povTimer >= 0.3 then
			povTimer = 0
			local myChar = LocalPlayer.Character
			local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
			if not myHRP then closestTarget=nil return end
			local bestDist = math.huge
			closestTarget = nil
			for _, char in pairs(characterCache) do
				local hrp = char:FindFirstChild("HumanoidRootPart")
				if hrp then
					local d = (myHRP.Position - hrp.Position).Magnitude
					if d < bestDist then
						bestDist = d
						closestTarget = char
					end
				end
			end
			if closestTarget then
				Camera.CameraType = Enum.CameraType.Scriptable
				Camera.CFrame = CFrame.new(Camera.CFrame.Position, closestTarget.HumanoidRootPart.Position)
			end
		end
	else
		Camera.CameraType = Enum.CameraType.Custom
	end
end)

-- -----------------
-- Infinite Jump
-- -----------------
UserInputService.JumpRequest:Connect(function()
	if infJumpEnabled then
		local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)

-- -----------------
-- NoClip
-- -----------------
RunService.Stepped:Connect(function()
	if noclipEnabled then
		local char = LocalPlayer.Character
		if char then
			for _, p in pairs(char:GetDescendants()) do
				if p:IsA("BasePart") then
					p.CanCollide = false
				end
			end
		end
	end
end)
