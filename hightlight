--// Player Utility: Collapsible Toggle GUI
--// LocalScript | StarterPlayerScripts

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- STATES
local highlightsEnabled = false
local povLockEnabled = false
local infJumpEnabled = false
local noclipEnabled = false
local walkSpeed = 16

local highlights = {}
local characterCache = {}
local closestTarget
local povConnection
local noclipConnection

-- GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CollapsibleUtilityGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer.PlayerGui

-- Master toggle button
local MasterButton = Instance.new("TextButton")
MasterButton.Size = UDim2.new(0, 220, 0, 50)
MasterButton.Position = UDim2.new(0,20,0.5,-150)
MasterButton.Text = "Toggle Utility GUI"
MasterButton.Font = Enum.Font.GothamBold
MasterButton.TextScaled = true
MasterButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
MasterButton.TextColor3 = Color3.fromRGB(255,255,255)
MasterButton.Active = true
MasterButton.Parent = ScreenGui
MasterButton.Draggable = true

-- Main frame
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0,220,0,50) -- initial height 50
Frame.Position = UDim2.new(0,20,0.5,-100)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.Visible = false
Frame.Parent = ScreenGui
Frame.Draggable = true

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0,5)
UIListLayout.FillDirection = Enum.FillDirection.Vertical
UIListLayout.Parent = Frame

MasterButton.MouseButton1Click:Connect(function()
	Frame.Visible = not Frame.Visible
end)

-- Helper function: create collapsible section
local function createSection(title)
	local header = Instance.new("TextButton")
	header.Size = UDim2.new(0, 200, 0, 40)
	header.BackgroundColor3 = Color3.fromRGB(50,50,50)
	header.TextColor3 = Color3.fromRGB(255,255,255)
	header.Font = Enum.Font.GothamBold
	header.TextScaled = true
	header.Text = title
	header.Active = true
	header.Parent = Frame

	local content = Instance.new("Frame")
	content.Size = UDim2.new(0,200,0,0)
	content.BackgroundTransparency = 1
	content.ClipsDescendants = true
	content.Parent = Frame

	local isOpen = false
	header.MouseButton1Click:Connect(function()
		isOpen = not isOpen
		content.Size = isOpen and UDim2.new(0,200,0,50) or UDim2.new(0,200,0,0)
	end)
	return content, header
end

-- Highlight section
local highlightSection, _ = createSection("Highlight")
local HighlightButton = Instance.new("TextButton")
HighlightButton.Size = UDim2.new(0,200,0,40)
HighlightButton.Position = UDim2.new(0,0,0,0)
HighlightButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
HighlightButton.TextColor3 = Color3.fromRGB(255,255,255)
HighlightButton.Font = Enum.Font.GothamBold
HighlightButton.TextScaled = true
HighlightButton.Text = "OFF"
HighlightButton.Parent = highlightSection

-- POV section
local povSection, _ = createSection("POV Lock")
local PovButton = Instance.new("TextButton")
PovButton.Size = UDim2.new(0,200,0,40)
PovButton.Position = UDim2.new(0,0,0,0)
PovButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
PovButton.TextColor3 = Color3.fromRGB(255,255,255)
PovButton.Font = Enum.Font.GothamBold
PovButton.TextScaled = true
PovButton.Text = "OFF"
PovButton.Parent = povSection

-- Infinite Jump section
local jumpSection, _ = createSection("Infinite Jump")
local JumpButton = Instance.new("TextButton")
JumpButton.Size = UDim2.new(0,200,0,40)
JumpButton.Position = UDim2.new(0,0,0,0)
JumpButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
JumpButton.TextColor3 = Color3.fromRGB(255,255,255)
JumpButton.Font = Enum.Font.GothamBold
JumpButton.TextScaled = true
JumpButton.Text = "OFF"
JumpButton.Parent = jumpSection

-- NoClip section
local noclipSection, _ = createSection("NoClip")
local NoClipButton = Instance.new("TextButton")
NoClipButton.Size = UDim2.new(0,200,0,40)
NoClipButton.Position = UDim2.new(0,0,0,0)
NoClipButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
NoClipButton.TextColor3 = Color3.fromRGB(255,255,255)
NoClipButton.Font = Enum.Font.GothamBold
NoClipButton.TextScaled = true
NoClipButton.Text = "OFF"
NoClipButton.Parent = noclipSection

-- WalkSpeed section
local speedSection, _ = createSection("WalkSpeed")
local SpeedDown = Instance.new("TextButton")
SpeedDown.Size = UDim2.new(0,50,0,40)
SpeedDown.Position = UDim2.new(0,0,0,0)
SpeedDown.Text = "-"
SpeedDown.Font = Enum.Font.GothamBold
SpeedDown.TextScaled = true
SpeedDown.BackgroundColor3 = Color3.fromRGB(40,40,40)
SpeedDown.TextColor3 = Color3.fromRGB(255,255,255)
SpeedDown.Parent = speedSection

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(0,100,0,40)
SpeedLabel.Position = UDim2.new(0,55,0,0)
SpeedLabel.Text = "16"
SpeedLabel.Font = Enum.Font.GothamBold
SpeedLabel.TextScaled = true
SpeedLabel.BackgroundColor3 = Color3.fromRGB(40,40,40)
SpeedLabel.TextColor3 = Color3.fromRGB(255,255,255)
SpeedLabel.Parent = speedSection

local SpeedUp = Instance.new("TextButton")
SpeedUp.Size = UDim2.new(0,50,0,40)
SpeedUp.Position = UDim2.new(0,160,0,0)
SpeedUp.Text = "+"
SpeedUp.Font = Enum.Font.GothamBold
SpeedUp.TextScaled = true
SpeedUp.BackgroundColor3 = Color3.fromRGB(40,40,40)
SpeedUp.TextColor3 = Color3.fromRGB(255,255,255)
SpeedUp.Parent = speedSection

-- -----------------
-- FUNCTIONS
-- -----------------

-- CHARACTER CACHE
local function cachePlayer(plr)
	if plr == LocalPlayer then return end
	local function onChar(char)
		characterCache[plr] = char
		if highlightsEnabled then
			local hl = Instance.new("Highlight")
			hl.FillColor = Color3.fromRGB(255,0,0)
			hl.OutlineColor = Color3.fromRGB(255,255,255)
			hl.FillTransparency = 0.5
			hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			hl.Adornee = char
			hl.Parent = char
			highlights[char] = hl
		end
	end
	if plr.Character then onChar(plr.Character) end
	plr.CharacterAdded:Connect(onChar)
end
for _, plr in ipairs(Players:GetPlayers()) do cachePlayer(plr) end
Players.PlayerAdded:Connect(cachePlayer)
Players.PlayerRemoving:Connect(function(plr)
	local char = characterCache[plr]
	if char and highlights[char] then highlights[char]:Destroy() end
	characterCache[plr] = nil
end)

-- HIGHLIGHT TOGGLE
HighlightButton.MouseButton1Click:Connect(function()
	highlightsEnabled = not highlightsEnabled
	HighlightButton.Text = highlightsEnabled and "ON" or "OFF"
	HighlightButton.BackgroundColor3 = highlightsEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
	if highlightsEnabled then
		for _, char in pairs(characterCache) do
			if not highlights[char] then
				local hl = Instance.new("Highlight")
				hl.FillColor = Color3.fromRGB(255,0,0)
				hl.OutlineColor = Color3.fromRGB(255,255,255)
				hl.FillTransparency = 0.5
				hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
				hl.Adornee = char
				hl.Parent = char
				highlights[char] = hl
			end
		end
	else
		for _, hl in pairs(highlights) do hl:Destroy() end
		table.clear(highlights)
	end
end)

-- POV LOCK
local timer = 0
local function updateClosest()
	local myChar = LocalPlayer.Character
	local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
	if not myHRP then closestTarget=nil return end
	local bestDist = math.huge
	closestTarget = nil
	for _, char in pairs(characterCache) do
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if hrp then
			local d = (myHRP.Position - hrp.Position).Magnitude
			if d < bestDist then
				bestDist = d
				closestTarget = char
			end
		end
	end
end

local function startPov()
	Camera.CameraType = Enum.CameraType.Scriptable
	povConnection = RunService.RenderStepped:Connect(function(dt)
		timer+=dt
		if timer>0.2 then updateClosest() timer=0 end
		if closestTarget and closestTarget:FindFirstChild("HumanoidRootPart") then
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, closestTarget.HumanoidRootPart.Position)
		end
	end)
end
local function stopPov() if povConnection then povConnection:Disconnect() end Camera.CameraType = Enum.CameraType.Custom end

PovButton.MouseButton1Click:Connect(function()
	povLockEnabled = not povLockEnabled
	PovButton.Text = povLockEnabled and "ON" or "OFF"
	PovButton.BackgroundColor3 = povLockEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
	if povLockEnabled then startPov() else stopPov() end
end)

-- Infinite Jump
UserInputService.JumpRequest:Connect(function()
	if infJumpEnabled then
		local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
	end
end)
JumpButton.MouseButton1Click:Connect(function()
	infJumpEnabled = not infJumpEnabled
	JumpButton.Text = infJumpEnabled and "ON" or "OFF"
	JumpButton.BackgroundColor3 = infJumpEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
end)

-- NoClip
local function startNoClip()
	noclipConnection = RunService.Stepped:Connect(function()
		local char = LocalPlayer.Character
		if char then
			for _, p in pairs(char:GetDescendants()) do
				if p:IsA("BasePart") then p.CanCollide = false end
			end
		end
	end)
end
local function stopNoClip() if noclipConnection then noclipConnection:Disconnect() end end
NoClipButton.MouseButton1Click:Connect(function()
	noclipEnabled = not noclipEnabled
	NoClipButton.Text = noclipEnabled and "ON" or "OFF"
	NoClipButton.BackgroundColor3 = noclipEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(40,40,40)
	if noclipEnabled then startNoClip() else stopNoClip() end
end)

-- WalkSpeed
local function applySpeed()
	local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
	if hum then hum.WalkSpeed = walkSpeed end
	SpeedLabel.Text = walkSpeed
end
SpeedUp.MouseButton1Click:Connect(function() walkSpeed = math.clamp(walkSpeed+4,8,200); applySpeed() end)
SpeedDown.MouseButton1Click:Connect(function() walkSpeed = math.clamp(walkSpeed-4,8,200); applySpeed() end)
LocalPlayer.CharacterAdded:Connect(function() task.wait(0.2); applySpeed() end)
